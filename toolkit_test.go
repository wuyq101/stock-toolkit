package stk

import (
	"fmt"
	"testing"
)

func TestMA(t *testing.T) {
	data := []float64{
		7.1000,
		7.1200,
		7.0400,
		6.9700,
		6.6300,
		6.6800,
		6.6900,
		6.7500,
		6.9100,
		6.8800,
		6.9100,
		7.1600,
		7.1100,
	}
	expected := []float64{
		0.0,
		0.0,
		0.0,
		0.0,
		6.97,
		6.89,
		6.80,
		6.74,
		6.73,
		6.78,
		6.83,
		6.92,
		6.99,
	}
	result := MA(data, 5)
	fmt.Printf("%v\n", result)
	for i := 0; i < len(result); i++ {
		if !FloatEqual(result[i], expected[i], 0.01) {
			t.Fatalf("%d expected %f, but was %f", i, expected[i], result[i])
		}
	}
}

func TestEMA(t *testing.T) {
	data := []float64{
		7.1000,
		7.1200,
		7.0400,
		6.9700,
		6.6300,
		6.6800,
		6.6900,
		6.7500,
		6.9100,
		6.8800,
		6.9100,
		7.1600,
		7.1100,
	}
	expected := []float64{
		7.10,
		7.11,
		7.08,
		7.05,
		6.91,
		6.83,
		6.78,
		6.77,
		6.82,
		6.84,
		6.86,
		6.96,
		7.01,
	}
	result := EMA(data, 5)
	fmt.Printf("%v\n", result)
	for i := 0; i < len(result); i++ {
		if !FloatEqual(result[i], expected[i], 0.01) {
			t.Fatalf("%d expected %f, but was %f", i, expected[i], result[i])
		}
	}
}

func TestBIAS(t *testing.T) {
	data := []float64{
		7.1000,
		7.1200,
		7.0400,
		6.9700,
		6.6300,
		6.6800,
		6.6900,
		6.7500,
		6.9100,
		6.8800,
		6.9100,
		7.1600,
		7.1100,
	}
	expected := []float64{
		0.0,
		0.0,
		0.0,
		0.0,
		-0.049053,
		-0.030197,
		-0.016466,
		0.000890,
		0.026441,
		0.014450,
		0.012009,
		0.034383,
		0.016586,
	}
	result := BIAS(data, 5)
	fmt.Printf("%v\n", result)
	for i := 0; i < len(result); i++ {
		if !FloatEqual(result[i], expected[i], 0.01) {
			t.Fatalf("%d expected %f, but was %f", i, expected[i], result[i])
		}
	}
}

func TestBBI(t *testing.T) {
	t.Skip()
	data := []float64{
		45.06,
		49.57,
		54.53,
		59.98,
		60.7,
		61.41,
		64.97,
		60.76,
		55.7,
		56.78,
		57.55,
		56.66,
		57.89,
		59.3,
		58.26,
		60.5,
		59.87,
		56.84,
		52.83,
		53.86,
		54.25,
		53.83,
		53.68,
		52.54,
		53.41,
		53.88,
		52.96,
	}
	expected := []float64{
		45.06,
		45.977599999999995,
		47.674033333333334,
		50.06163333333334,
		52.01793333333333,
		53.66593333333333,
		55.67246666666667,
		56.371633333333335,
		55.92576666666667,
		55.86583333333334,
		57.54999999999999,
		57.368900000000004,
		57.48356666666666,
		59.29999999999999,
		58.26,
		57.5177,
		57.86606666666666,
		57.53133333333333,
		56.48493333333332,
		55.924333333333344,
		55.58566666666667,
		55.243533333333325,
		54.951766666666664,
		54.49453333333333,
		54.32153333333333,
		54.27766666666667,
		54.04836666666667,
	}

	ema := EMA(data, 12)
	for i, e := range ema {
		fmt.Printf("i: %d, e: %.4f\n", i, e)
	}
	// fmt.Printf("%v\n", EMA(data, 10))
	result := BBI(data)
	// fmt.Printf("bbi:%v\n", result)
	for i := 0; i < len(result); i++ {
		if !FloatEqual(result[i], expected[i], 0.01) {
			t.Fatalf("%d expected %f, but was %f", i, expected[i], result[i])
		}
	}
}
func TestUPR(t *testing.T) {
	close := []float64{
		49.61,
		48.94,
		47.92,
		50.42,
		51.39,
		51.01,
		51.13,
		51.23,
		50.61,
		51.63,
		52.77,
		53.9,
		53.47,
		53.84,
		54.01,
		51.96,
		52.61,
		52.31,
		51.89,
		52.36,
		51.89,
		52.02,
		54.85,
		54.04,
		52.92,
		51.94,
		52.32,
		52.45,
		52.06,
		50.73,
		49.58,
		50.49,
		50.9,
		51.21,
		51.1,
		53.17,
		53.03,
		55.2,
		55.4,
		55.12,
		55.83,
		56.2,
		57.06,
		56.41,
		56.03,
		56.17,
		55.15,
		56.29,
		55.4,
		54.91,
		55.02,
		53.99,
		54.81,
		55.07,
		54.02,
		53.38,
		53.3,
		53.46,
		53.08,
		53.82,
		54.04,
		54.16,
		54.25,
		53.6,
		53.74,
		54.16,
		54.76,
		54.92,
		55.31,
		57.11,
		57.08,
		57.17,
		57.94,
		58.98,
		59.59,
		59.02,
		59.88,
		60.2,
		60.08,
		61.39,
		63.93,
		64.06,
		64.36,
		64.12,
		64.14,
		64.45,
		64.01,
		65.37,
		64.61,
		66.33,
		69.89,
		70.15,
		70.42,
		69.2,
		73.01,
		75.27,
		75.71,
		78.44,
		77.45,
		74.32,
		74.62,
		73.55,
		72.73,
		72.42,
		69.92,
		68.1,
		69.39,
		71.2,
		69.4,
		68.64,
		71.49,
		73.25,
		71.21,
		72.12,
		71.01,
		70.38,
		70.67,
		73.58,
		73.94,
		74.91,
		74.02,
		74.16,
		73.94,
		70.35,
		70.59,
		69.98,
		72.59,
		70.97,
		71.18,
		70.89,
		70.01,
		71.87,
		71.72,
		72.65,
		74.41,
		77.65,
		77.81,
		77.34,
		77.61,
		77.59,
		78.74,
		78.76,
		76.44,
		75.29,
	}
	result := UPR(close, 10, -3)
	for _, v := range result {
		fmt.Printf("%v\n", v)
	}
}

var (
	close = []float64{
		45.06,
		49.57,
		54.53,
		59.98,
		60.7,
		61.41,
		64.97,
		60.76,
		55.7,
		56.78,
		57.55,
		56.66,
		57.89,
		59.3,
		58.26,
		60.5,
		59.87,
		56.84,
		52.83,
		53.86,
		54.25,
		53.83,
		53.68,
		52.54,
		53.41,
		53.88,
		52.96,
	}
)

func TestHHV(t *testing.T) {
	hhv := HHV(close, 4)
	fmt.Printf("%v", hhv)
}